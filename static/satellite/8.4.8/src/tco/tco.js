"use strict";var d3=require("d3"),debugLib=require("debug"),debug=debugLib("tco"),_require=require("./tco_calc"),calcTco=_require.calcTco,calcSaving=_require.calcSaving,_require2=require("./tco_inputs"),initInputs=_require2.initInputs,getInputs=_require2.getInputs,serialiseInputs=_require2.serialiseInputs,clone=function(obj){return JSON.parse(JSON.stringify(obj))},humanNumber=function(value){return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},toPercentage=function(value){return"".concat(humanNumber((100*value).toFixed(2)),"%")},toMoney=function(value){return"$".concat(humanNumber(value.toFixed(0)))},getUrlParameter=require("../common/get_url_param");initInputs();var getColour=function(colour,opacity){return"rgba(".concat(colour,", ").concat(opacity,")")},colours={blue:"0, 103, 255",purple:"133, 0, 255",red:"255, 0, 68",orange:"241, 88, 24"},config={width:600,height:300,xPadding:.2},margin={top:0,right:10,bottom:20,left:80},width=config.width-margin.left-margin.right,height=config.height-margin.top-margin.bottom,x=d3.scaleBand().rangeRound([0,width]).padding(config.xPadding),y=d3.scaleLinear().rangeRound([height,0]),customYAxis=function(g){g.call(d3.axisRight(y).tickSize(width).tickFormat(""));g.select(".domain").remove();g.selectAll(".tick:not(:first-of-type) line").attr("stroke","#777").attr("stroke-dasharray","2,2")},tco_graph=d3.select("#tco-graph"),svg=tco_graph.append("svg").attr("viewBox","0 0 ".concat(config.width," ").concat(config.height));tco_graph.append("p").attr("class","is-white text-center unpad").text("Systems Removed");var tooltip=tco_graph.append("div").attr("class","d3-tooltip").style("opacity",0),g=svg.append("g").attr("transform","translate(".concat(margin.left,",").concat(margin.top,")")).style("font-family","Helvetica Neue\",Helvetica,Roboto,Arial,sans-serif").style("font-size","14px");g.append("g").attr("class","axis axis--x").style("font-size","14px").attr("transform","translate(0,".concat(height,")"));g.append("g").attr("class","axis axis--y").style("font-size","14px");g.append("g").attr("class","axis axis--y-right");var setBars=function(bar){bar.attr("stroke-dashoffset",function(d){return height-y(d.total)}).attr("stroke-dasharray",function(d){return"".concat(2*(height-y(d.total))+x.bandwidth(),", ").concat(x.bandwidth())}).attr("x",function(d){return x(d.id)}).attr("y",function(d){return y(d.total)}).attr("width",x.bandwidth()).attr("height",function(d){return height-y(d.total)})},setSaving=function(bar){var _Mathmin=Math.min,_Mathmax=Math.max;bar.select("rect").attr("x",function(d){return x(d.id)}).attr("y",function(d){return height-y(d.saving)-3}).attr("width",x.bandwidth()).attr("height",0);bar.select(".text-percentage").attr("x",function(d){return x(d.id)+x.bandwidth()/2}).attr("y",function(d){return _Mathmin(10,100*_Mathmax(d.saving_percentage-.1,0))+10}).attr("text-anchor","middle").text(function(d){return .045<d.saving_percentage?toPercentage(d.saving_percentage):""});bar.select(".text-saving").attr("x",function(d){return x(d.id)+x.bandwidth()/2}).attr("y",function(d){return _Mathmin(10,100*_Mathmax(d.saving_percentage-.1,0))+23}).attr("text-anchor","middle").text(function(d){return .1<d.saving_percentage?"saving":""})},render=function(){var inputs=getInputs();debug("inputs",inputs);var calcs=Array(Math.min(5,inputs.software.num_systems)).fill(clone(inputs)).map(calcTco).map(calcSaving);debug("calcs",calcs);x.domain(calcs.map(function(d){return d.id}));g.select(".axis--x").transition().call(d3.axisBottom(x).tickFormat(function(d){return d?"".concat(d," removed"):"Current Situation"}));y.domain([0,calcs[0].total]);g.select(".axis--y").transition().call(d3.axisLeft(y).tickFormat(function(d){return toMoney(d)}));g.select(".axis--y-right").call(customYAxis);var update=g.selectAll(".bar").data(calcs,function(d){return d.id}),enter=update.enter().append("rect").attr("class","bar").on("mouseover",function(d){var barCoords=this.getBoundingClientRect(),bar={left:barCoords.left+window.scrollX,top:barCoords.top+window.scrollY,width:barCoords.width,height:barCoords.height},text=[];if(d.saving){text.push("TCO: ".concat(toMoney(d.total)));text.push("Saving: <strong>".concat(toMoney(d.saving),"</strong>"));var saving=d3.select(svg.selectAll(".bar--saving").nodes()[d.id]).select("rect"),saving_y=saving.attr("y"),saving_height=saving.attr("height");saving.classed("swapped",!0).attr("y",saving_height).attr("height",saving_y)}else{text.push("TCO: ".concat(toMoney(d.total)))}tooltip.transition().duration(200).style("opacity",.9);tooltip.html(text.join("<br>"));var tooltip_width=tooltip.node().getBoundingClientRect().width,tooltip_left=bar.left+(bar.width-tooltip_width)/2,tooltip_top=bar.top+10;tooltip.style("left","".concat(tooltip_left,"px")).style("top","".concat(tooltip_top,"px"))}).on("mouseout",function(){svg.selectAll(".bar--saving .swapped").each(function(){var saving=d3.select(this),saving_y=saving.attr("y"),saving_height=saving.attr("height");saving.classed("swapped",!1).attr("y",saving_height).attr("height",saving_y)});tooltip.transition().duration(500).style("opacity",0)}).call(setBars);update.exit().remove();update.transition().call(setBars);update.merge(enter);var update_saving_g=g.selectAll(".bar--saving").data(calcs,function(d){return d.id}),enter_saving_g=update_saving_g.enter().append("g").attr("class","bar--saving");enter_saving_g.append("rect");enter_saving_g.append("text").attr("class","text-percentage");enter_saving_g.append("text").attr("class","text-saving");enter_saving_g.call(setSaving);update_saving_g.transition().call(setSaving);update_saving_g.merge(enter_saving_g);update_saving_g.exit().remove()},updateSliderValue=function(){var id=this.id,value=+this.value,display=d3.select("#".concat(id,"_value")),prefix=display.classed("money")?"$":"";display.text(prefix+humanNumber(value))},sliders=d3.select("#sliders");sliders.selectAll("input[type=range]").on("input",function(){updateSliderValue.call(this);render()}).each(updateSliderValue);render();if(!getUrlParameter("return")){var goNext=function(e){if("click"===e.type||"Enter"===e.key){var typeform_url="https://nuxeosurveys.typeform.com/to/wO46m7?"+serialiseInputs();document.getElementById("typeform").setAttribute("data-url",typeform_url);(function(){var js,q,d=document,gi=d.getElementById,ce=d.createElement,gt=d.getElementsByTagName,id="typef_orm";if(!gi.call(d,id)){js=ce.call(d,"script");js.id=id;js.src="https://embed.typeform.com/"+"embed.js";q=gt.call(d,"script")[0];q.parentNode.insertBefore(js,q)}})();document.getElementById("results").classList.add("hide");document.getElementById("typeform").classList.remove("hide");document.getElementById("next").removeEventListener("click",goNext);document.removeEventListener("keyup",goNext)}};document.getElementById("next").addEventListener("click",goNext);document.addEventListener("keyup",goNext);document.querySelectorAll(".no-return").forEach(function(e){e.classList.remove("hide")})}